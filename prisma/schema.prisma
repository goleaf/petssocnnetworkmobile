// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Article {
  id          String    @id @default(uuid())
  slug        String
  title       String
  type        String
  status      String
  createdById String
  assignedTo  String? // Expert reviewer assigned for quality review
  updatedAt   DateTime  @updatedAt
  createdAt   DateTime  @default(now())
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  revisions   Revision[]
  tags        ArticleTag[]
  props       ArticleProp[]
  sources     Source[]
  searchIndex ArticleSearchIndex?

  @@unique([slug, type])
  @@index([deletedAt])
  @@index([assignedTo])
  @@map("articles")
}

model Revision {
  id           String    @id @default(uuid())
  articleId    String
  rev          Int
  authorId     String
  summary      String?
  contentJSON  Json
  infoboxJSON  Json?
  approvedById String?
  approvedAt   DateTime?
  createdAt    DateTime  @default(now())

  // Relations
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, rev])
  @@index([articleId])
  @@index([contentJSON(ops: JsonbPathOps)], type: Gin)
  @@map("revisions")
}

model ArticleTag {
  articleId String
  tag       String

  // Relations
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@id([articleId, tag])
  @@index([tag])
  @@map("article_tags")
}

model ArticleProp {
  articleId String
  key       String
  value     Json

  // Relations
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@id([articleId, key])
  @@index([articleId])
  @@index([value(ops: JsonbPathOps)], type: Gin)
  @@map("article_props")
}

// Source model for wiki article citations
model Source {
  id          String    @id @default(uuid())
  articleId   String
  sourceId    String // Citation ID (e.g., "1", "2")
  title       String
  url         String
  publisher   String?
  date        String?
  license     String?
  brokenAt    DateTime?
  isValid     Boolean?
  lastChecked DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  article Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, sourceId])
  @@index([articleId])
  @@index([url])
  @@map("sources")
}

// FTS search index for articles
// Note: tsvector type should be handled via raw SQL in migrations
model ArticleSearchIndex {
  articleId String  @id
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  content   String // tsvector in actual database, but mapped as String in Prisma

  @@map("article_search_index")
}

// Blog Post model for FTS search
model BlogPost {
  id         String    @id @default(uuid())
  petId      String
  authorId   String
  title      String
  content    String
  coverImage String?
  tags       String[]
  categories String[]
  likes      String[]
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  privacy    String    @default("public")
  isDraft    Boolean   @default(false)
  hashtags   String[]
  type       String    @default("blog_post")
  deletedAt  DateTime? @map("deleted_at")

  // Relations
  postTags    BlogPostTag[]
  searchIndex BlogPostSearchIndex?

  @@index([deletedAt])
  @@map("blog_posts")
}

// Join table for blog post tags
model BlogPostTag {
  postId String
  tag    String

  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([postId, tag])
  @@index([tag])
  @@map("blog_post_tags")
}

// FTS search index for blog posts
// Note: tsvector type should be handled via raw SQL in migrations
model BlogPostSearchIndex {
  postId  String   @id
  post    BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  content String // tsvector in actual database, but mapped as String in Prisma

  @@map("blog_post_search_index")
}

// Synonyms for FTS search expansion
model Synonym {
  id        String   @id @default(uuid())
  term      String   @unique
  synonyms  String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([term])
  @@map("synonyms")
}

// Alias sets for grouping equivalent terms
model AliasSet {
  id        String   @id @default(uuid())
  name      String   @unique
  aliases   String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("alias_sets")
}

// Term boosts for search ranking
model TermBoost {
  id        String   @id @default(uuid())
  term      String   @unique
  boost     Float    @default(1.0) // 0.0 to 10.0
  field     String? // Optional field to boost (e.g., 'title', 'content')
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([term])
  @@index([field])
  @@map("term_boosts")
}

// Telemetry for search queries
model SearchTelemetry {
  id              String   @id @default(uuid())
  query           String
  resultCount     Int      @default(0)
  hasResults      Boolean  @default(false)
  zeroResultQuery Boolean  @default(false) // Track zero-result queries specifically
  entityTypes     String[] // Array of entity types searched (e.g., ["blog_post", "article", "place"])
  filters         Json? // Store filters as JSON (species, tags, etc.)
  createdAt       DateTime @default(now())
  ipAddress       String?
  userAgent       String?

  @@index([createdAt])
  @@index([hasResults])
  @@index([zeroResultQuery])
  @@map("search_telemetry")
}

// Saved searches with alert preferences
model SavedSearch {
  id            String    @id @default(uuid())
  userId        String? // Nullable - can be anonymous (stored in localStorage)
  query         String
  filters       Json // Store filters as JSON (species, tags, entityTypes, etc.)
  entityTypes   String[] // Array of entity types to search (e.g., ["blog_post", "article"])
  latLng        Json? // Optional geo coordinates { lat: number, lng: number }
  radius        Float? // Optional radius in kilometers for geo search
  alertEnabled  Boolean   @default(false)
  lastCheckedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  alerts SearchAlert[]

  @@index([userId])
  @@index([alertEnabled])
  @@index([createdAt])
  @@map("saved_searches")
}

// Search alerts - track when new results appear for saved searches
model SearchAlert {
  id                String    @id @default(uuid())
  savedSearchId     String
  matchedEntityId   String // ID of the entity that matched
  matchedEntityType String // Type of entity (e.g., "blog_post", "article", "place")
  notifiedAt        DateTime?
  createdAt         DateTime  @default(now())

  // Relations
  savedSearch SavedSearch @relation(fields: [savedSearchId], references: [id], onDelete: Cascade)

  @@index([savedSearchId])
  @@index([matchedEntityType, matchedEntityId])
  @@index([createdAt])
  @@map("search_alerts")
}

// Breed model
model Breed {
  id              String   @id @default(uuid())
  name            String   @unique
  species         String // dog, cat, bird, etc.
  description     String?
  characteristics Json? // JSON field for breed characteristics
  averageWeight   String?
  averageLifespan String?
  temperament     String[]
  origin          String?
  photoUrl        String? // Photo for autocomplete display
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([species])
  @@index([name])
  @@map("breeds")
}

// City model
model City {
  id         String   @id @default(uuid())
  name       String
  country    String
  state      String?
  latitude   Float?
  longitude  Float?
  population Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  places Place[]

  @@unique([name, country, state])
  @@index([name])
  @@index([country])
  @@map("cities")
}

// Place model
model Place {
  id               String    @id @default(uuid())
  name             String
  address          String
  cityId           String
  latitude         Float
  longitude        Float
  amenities        String[]
  rules            String[]
  moderationStatus String    @default("approved") // approved, pending, rejected
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime? @map("deleted_at")

  // Relations
  city City @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@index([cityId])
  @@index([moderationStatus])
  @@index([latitude, longitude])
  @@index([deletedAt])
  @@map("places")
}

// Product model
model Product {
  id            String    @id @default(uuid())
  name          String
  brand         String?
  category      String // food, toys, accessories, health, etc.
  description   String?
  price         Float?
  currency      String    @default("USD")
  imageUrl      String?
  tags          String[]
  inStock       Boolean   @default(true)
  rating        Float?
  reviewCount   Int       @default(0)
  isRecalled    Boolean   @default(false)
  recallNotice  String?
  safetyNotices String[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? @map("deleted_at")

  @@index([category])
  @@index([brand])
  @@index([name])
  @@index([isRecalled])
  @@index([deletedAt])
  @@map("products")
}

// Report Reason model - predefined reasons for reporting content
model ReportReason {
  id          String   @id @default(uuid())
  code        String   @unique // e.g., "spam", "harassment", "misinformation"
  name        String // Human-readable name
  description String?
  category    String // "content", "behavior", "safety", etc.
  severity    String   @default("medium") // low, medium, high, critical
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  reports ContentReport[]

  @@index([code])
  @@index([category])
  @@index([active])
  @@map("report_reasons")
}

// Content Report model - user reports on any content
model ContentReport {
  id           String    @id @default(uuid())
  reporterId   String
  contentType  String // "blog_post", "article", "comment", "place", "product", etc.
  contentId    String
  reasonId     String // Reference to ReportReason
  customReason String? // For "other" cases
  description  String?
  status       String    @default("pending") // pending, investigating, resolved, dismissed
  priority     String    @default("low") // low, medium, high, urgent
  assignedTo   String? // Moderator/admin assigned
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  resolvedAt   DateTime?

  // Relations
  reason ReportReason @relation(fields: [reasonId], references: [id])

  @@index([reporterId])
  @@index([contentType, contentId])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("content_reports")
}

// Moderator Queue model - tracks items awaiting moderation
model ModerationQueue {
  id          String    @id @default(uuid())
  contentType String // Type of content
  contentId   String
  priority    String    @default("low") // low, medium, high, urgent
  reportedBy  String[] // Array of user IDs who reported
  reportCount Int       @default(1) // Count of reports on this item
  autoFlagged Boolean   @default(false) // Whether auto-moderated
  autoReason  String? // Reason if auto-flagged
  status      String    @default("pending") // pending, in_review, resolved
  assignedTo  String? // Moderator assigned
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  reviewedAt  DateTime?

  @@unique([contentType, contentId])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("moderation_queue")
}

// Soft Delete Audit model - tracks all soft deletions
model SoftDeleteAudit {
  id          String    @id @default(uuid())
  contentType String // What was deleted
  contentId   String
  deletedBy   String // User/moderator who deleted
  reason      String? // Reason for deletion
  metadata    Json? // Additional context
  deletedAt   DateTime  @default(now())
  restoredAt  DateTime? // If restored
  restoredBy  String?

  @@index([contentType, contentId])
  @@index([deletedBy])
  @@index([deletedAt])
  @@index([restoredAt])
  @@map("soft_delete_audit")
}

// Moderation Action model - tracks moderation actions taken
model ModerationActionLog {
  id          String   @id @default(uuid())
  action      String // "approve", "reject", "delete", "warn", "ban", etc.
  contentType String // Type of content affected
  contentId   String
  performedBy String // Moderator/admin
  reason      String?
  metadata    Json? // Additional details
  createdAt   DateTime @default(now())

  @@index([action])
  @@index([contentType, contentId])
  @@index([performedBy])
  @@index([createdAt])
  @@map("moderation_action_logs")
}

// Generic Audit Log model - tracks all admin actions
model AuditLog {
  id         String   @id @default(uuid())
  actorId    String // User/admin who performed the action
  action     String // Action type (e.g., "create", "update", "delete", "approve", etc.)
  targetType String // Type of entity affected (e.g., "blog_post", "article", "user", etc.)
  targetId   String // ID of the affected entity
  reason     String? // Optional reason for the action
  metadata   Json? // Additional context and details
  createdAt  DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Pending audit queue - for resilience when database is unavailable
model AuditQueue {
  id          String    @id @default(uuid())
  actorId     String
  action      String
  targetType  String
  targetId    String
  reason      String?
  metadata    Json?
  createdAt   DateTime  @default(now())
  attempts    Int       @default(0)
  lastAttempt DateTime?

  @@index([createdAt])
  @@index([attempts])
  @@map("audit_queue")
}

// Moderation Report model - user reports on content
model ModerationReport {
  id          String   @id @default(uuid())
  reporterId  String
  subjectType String // 'post' | 'comment' | 'media' | 'wiki'
  subjectId   String
  reason      String
  status      String   @default("open") // open|triaged|closed
  assignedTo  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  actions ModerationAction[]

  @@index([reporterId])
  @@index([subjectType, subjectId])
  @@index([status])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("moderation_reports")
}

// Moderation Action model - actions taken on reports
model ModerationAction {
  id        String   @id @default(uuid())
  reportId  String
  actorId   String
  type      String // warn|mute|shadowban|suspend|reject|approve
  reason    String?
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  report ModerationReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([actorId])
  @@index([type])
  @@index([createdAt])
  @@map("moderation_actions")
}

// Expert Profile model - expert verification for wiki governance
model ExpertProfile {
  userId     String    @id
  credential String
  licenseNo  String?
  region     String?
  verifiedAt DateTime?
  expiresAt  DateTime?
  status     String    @default("pending") // pending|verified|revoked|expired
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([status])
  @@index([verifiedAt])
  @@index([expiresAt])
  @@map("expert_profiles")
}

// Flagged Revision model - wiki revisions flagged for expert review
model FlaggedRevision {
  id         String    @id @default(uuid())
  articleId  String
  revisionId String
  type       String // 'Health'|'Regulation'
  flaggedAt  DateTime  @default(now())
  status     String    @default("pending") // pending|approved|changes-requested|rolled-back
  assignedTo String?
  approvedBy String?
  approvedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([articleId])
  @@index([revisionId])
  @@index([status])
  @@index([type])
  @@index([flaggedAt])
  @@map("flagged_revisions")
}

// Notification Send Record - audit log for sent notifications
model NotificationSendRecord {
  id           String   @id @default(uuid())
  templateId   String?
  templateName String?
  type         String // email, push, in_app
  subject      String?
  body         String
  segment      Json // { roles: [], locales: [], groups: [] }
  targetCount  Int      @default(0)
  sentCount    Int      @default(0)
  failedCount  Int      @default(0)
  jobId        String? // Reference to queue job
  sentBy       String // Admin user ID
  createdAt    DateTime @default(now())

  @@index([templateId])
  @@index([sentBy])
  @@index([createdAt])
  @@index([jobId])
  @@map("notification_send_records")
}

// User model - core user account and authentication
model User {
  id                   String    @id @default(uuid())
  username             String    @unique
  email                String    @unique
  emailVerified        Boolean   @default(false)
  passwordHash         String
  passwordChangedAt    DateTime?
  sessionInvalidatedAt DateTime?

  // Profile information
  displayName String?
  bio         String?
  avatarUrl   String?
  role        String  @default("user") // user, moderator, admin

  // Privacy settings (JSON field)
  privacy Json?

  // Notification preferences
  notificationSettings Json?

  // Search and discoverability
  searchIndexingEnabled Boolean @default(true)
  showInSearch          Boolean @default(true)
  showInRecommendations Boolean @default(true)

  // Account deletion
  deletionScheduledAt DateTime?
  deletionReason      String?

  // Relations
  emailVerifications    EmailVerification[]
  sessions              Session[]
  blockedUsers          BlockedUser[]         @relation("UserBlocks")
  blockedBy             BlockedUser[]         @relation("BlockedUser")
  mutedUsers            MutedUser[]           @relation("UserMutes")
  mutedBy               MutedUser[]           @relation("MutedUser")
  editRequests          EditRequest[]         @relation("EditRequests")
  reviewedEdits         EditRequest[]         @relation("ReviewedEdits")
  whitelistedLinks      LinkWhitelist[]       @relation("WhitelistedLinks")
  blacklistedLinks      LinkBlacklist[]       @relation("BlacklistedLinks")
  moderationCategories  ModerationCategory[]  @relation("ModerationCategories")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([username])
  @@index([deletionScheduledAt])
  @@index([role])
  @@map("users")
}

// Email Verification model - tracks email change requests
model EmailVerification {
  id           String   @id @default(uuid())
  userId       String
  pendingEmail String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("email_verifications")
}

// Session model - tracks user login sessions
model Session {
  id             String   @id @default(uuid())
  userId         String
  token          String   @unique
  customName     String?
  deviceName     String?
  deviceType     String? // mobile, tablet, desktop
  os             String?
  browser        String?
  ip             String?
  city           String?
  country        String?
  revoked        Boolean  @default(false)
  createdAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())
  expiresAt      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([revoked])
  @@index([expiresAt])
  @@map("sessions")
}

// Blocked User model - tracks user blocking relationships
model BlockedUser {
  id        String   @id @default(uuid())
  userId    String
  blockedId String
  blockedAt DateTime @default(now())

  user    User @relation("UserBlocks", fields: [userId], references: [id], onDelete: Cascade)
  blocked User @relation("BlockedUser", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([userId, blockedId])
  @@index([userId])
  @@index([blockedId])
  @@map("blocked_users")
}

// Muted User model - tracks user muting relationships
model MutedUser {
  id      String   @id @default(uuid())
  userId  String
  mutedId String
  mutedAt DateTime @default(now())

  user  User @relation("UserMutes", fields: [userId], references: [id], onDelete: Cascade)
  muted User @relation("MutedUser", fields: [mutedId], references: [id], onDelete: Cascade)

  @@unique([userId, mutedId])
  @@index([userId])
  @@index([mutedId])
  @@map("muted_users")
}

// Deletion Restore Token model - tracks account deletion restore tokens
model DeletionRestoreToken {
  id        String   @id @default(uuid())
  userId    String   @unique
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
  @@index([expiresAt])
  @@map("deletion_restore_tokens")
}

// ============================================================================
// CONTENT FEED & TIMELINE SYSTEM
// ============================================================================

// Post model - main content posts in the feed
model Post {
  id           String  @id @default(uuid())
  authorUserId String
  postType     String  @default("standard") // standard, photo_album, video, poll, shared, question, event, marketplace
  textContent  String?

  // Media and attachments
  media Json? // Array of media items with URLs, types, captions

  // Social features
  petTags          String[] // Pet IDs tagged in post
  mentionedUserIds String[] // User IDs mentioned with @
  hashtags         String[] // Hashtags without # symbol
  location         Json? // { name, lat, lng, placeId }

  // Engagement counters (denormalized for performance)
  likesCount    Int @default(0)
  commentsCount Int @default(0)
  sharesCount   Int @default(0)
  savesCount    Int @default(0)
  viewsCount    Int @default(0)

  // Reactions breakdown
  reactions Json? // { like: 0, love: 0, haha: 0, wow: 0, sad: 0, angry: 0, paw: 0 }

  // Privacy and settings
  visibility        String   @default("public") // public, friends, private, custom, followers_only
  visibilityUserIds String[] // For custom visibility
  commentsEnabled   Boolean  @default(true)
  sharesEnabled     Boolean  @default(true)

  // Post type specific data
  pollOptions     Json? // For poll posts: { question, options: [{ id, text, votes }], totalVotes, expiresAt, allowMultiple }
  eventData       Json? // For event posts: { title, startAt, durationMinutes, timezone, location, rsvps }
  marketplaceData Json? // For marketplace posts: { price, currency, condition, category, shipping, paymentMethods, soldAt }
  questionData    Json? // For question posts: { category, bestAnswerCommentId }
  sharedPostId    String? // For shared posts
  shareComment    String? // Comment when sharing a post

  // Metadata
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  editedAt           DateTime?
  deletedAt          DateTime?
  scheduledPublishAt DateTime?
  publishedAt        DateTime?

  // Ranking and algorithm
  relevanceScore      Float     @default(0)
  lastScoreComputedAt DateTime?

  // Relations
  likes    PostLike[]
  comments Comment[]
  shares   PostShare[]
  saves    SavedPost[]
  views    PostView[]

  @@index([authorUserId, createdAt(sort: Desc)])
  @@index([publishedAt(sort: Desc)])
  @@index([relevanceScore(sort: Desc)])
  @@index([deletedAt])
  @@index([hashtags(ops: ArrayOps)], type: Gin)
  @@index([visibility])
  @@map("posts")
}

// Post Like model - tracks likes on posts
model PostLike {
  id           String   @id @default(uuid())
  postId       String
  userId       String
  reactionType String   @default("like") // like, love, haha, wow, sad, angry, paw
  createdAt    DateTime @default(now())

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("post_likes")
}

// Comment model - comments on posts
model Comment {
  id               String   @id @default(uuid())
  postId           String
  authorUserId     String
  parentCommentId  String? // For threaded replies
  textContent      String
  mediaUrl         String? // Optional image/gif in comment
  mentionedUserIds String[]

  // Engagement
  likesCount   Int @default(0)
  repliesCount Int @default(0)

  // Metadata
  createdAt DateTime  @default(now())
  editedAt  DateTime?
  deletedAt DateTime?
  isPinned  Boolean   @default(false)

  // Relations
  post    Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  likes   CommentLike[]
  replies Comment[]     @relation("CommentReplies")
  parent  Comment?      @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt(sort: Desc)])
  @@index([authorUserId])
  @@index([parentCommentId])
  @@index([deletedAt])
  @@map("comments")
}

// Comment Like model - tracks likes on comments
model CommentLike {
  id        String   @id @default(uuid())
  commentId String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
  @@map("comment_likes")
}

// Post Share model - tracks post shares
model PostShare {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  shareType String   @default("repost") // repost, quote, external
  caption   String? // For quote shares
  createdAt DateTime @default(now())

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("post_shares")
}

// Saved Post model - bookmarked posts
model SavedPost {
  id             String   @id @default(uuid())
  postId         String
  userId         String
  collectionName String? // Optional collection/folder name
  createdAt      DateTime @default(now())

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId, createdAt(sort: Desc)])
  @@map("saved_posts")
}

// Post View model - tracks post views for analytics
model PostView {
  id       String   @id @default(uuid())
  postId   String
  userId   String? // Nullable for anonymous views
  duration Int      @default(0) // Seconds viewed
  viewedAt DateTime @default(now())

  // Relations
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId, viewedAt(sort: Desc)])
  @@index([userId])
  @@map("post_views")
}

// Poll Vote model - tracks votes on poll posts
model PollVote {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  optionId  String // ID of the poll option voted for
  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
  @@map("poll_votes")
}

// ============================================================================
// STORIES SYSTEM
// ============================================================================

// Story model - 24-hour ephemeral content
model Story {
  id              String @id @default(uuid())
  creatorUserId   String
  mediaUrl        String
  mediaType       String // photo, video
  thumbnailUrl    String
  mediaDimensions Json // { width, height }
  videoDuration   Int? // Seconds, for videos

  // Content
  caption      String?
  stickers     Json? // Array of sticker objects with type, position, content
  musicTrackId String?
  linkUrl      String?

  // Privacy
  visibility         String   @default("everyone") // everyone, close_friends, custom
  visibilityUserIds  String[] // For custom visibility
  isSensitiveContent Boolean  @default(false)

  // Engagement counters
  viewsCount         Int @default(0)
  uniqueViewersCount Int @default(0)
  repliesCount       Int @default(0)
  reactionsCount     Int @default(0)
  sharesCount        Int @default(0)
  linkClicksCount    Int @default(0)

  // Lifecycle
  createdAt  DateTime  @default(now())
  expiresAt  DateTime
  deletedAt  DateTime?
  isArchived Boolean   @default(false)
  archivedAt DateTime?

  // Relations
  views        StoryView[]
  interactions StoryInteraction[]

  @@index([creatorUserId, expiresAt])
  @@index([expiresAt])
  @@index([deletedAt])
  @@index([isArchived])
  @@map("stories")
}

// Story View model - tracks who viewed stories
model StoryView {
  id           String   @id @default(uuid())
  storyId      String
  viewerUserId String
  duration     Int      @default(0) // Seconds watched
  completed    Boolean  @default(false) // Watched to end
  viewedAt     DateTime @default(now())

  // Relations
  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@unique([storyId, viewerUserId])
  @@index([storyId, viewedAt(sort: Desc)])
  @@index([viewerUserId])
  @@map("story_views")
}

// Story Interaction model - tracks interactions with story stickers
model StoryInteraction {
  id              String   @id @default(uuid())
  storyId         String
  userId          String
  interactionType String // poll_vote, question_response, quiz_answer, reaction, reply, link_click
  data            Json? // Type-specific data
  createdAt       DateTime @default(now())

  // Relations
  story Story @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([storyId, interactionType])
  @@index([userId])
  @@map("story_interactions")
}

// Story Highlight model - permanent collections of stories
model StoryHighlight {
  id        String   @id @default(uuid())
  userId    String
  name      String
  coverUrl  String // Cover image URL
  storyIds  String[] // Array of story IDs in this highlight
  order     Int      @default(0) // Display order
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, order])
  @@map("story_highlights")
}

// Close Friends model - curated list for private story sharing
model CloseFriend {
  id           String   @id @default(uuid())
  userId       String
  friendUserId String
  addedAt      DateTime @default(now())

  @@unique([userId, friendUserId])
  @@index([userId])
  @@index([friendUserId])
  @@map("close_friends")
}

// ============================================================================
// PET PROFILE SYSTEM
// ============================================================================

// Pet model - main pet profile information
model Pet {
  id       String @id @default(uuid())
  ownerId  String
  slug     String // URL-friendly identifier (e.g., "max-golden-retriever")
  name     String
  species  String // dog, cat, bird, rabbit, guinea_pig, hamster, fish, reptile, horse, farm_animal, other
  breedId  String? // Reference to Breed model
  breed    String? // Free text breed for non-dog/cat species

  // Physical characteristics
  gender           String? // male, female, unknown
  birthday         String? // ISO date string
  approximateAge   Json? // { years: number, months: number } for unknown exact birthday
  adoptionDate     String? // ISO date string
  color            String?
  markings         String? // Detailed appearance description
  weight           String? // Current weight with unit
  weightUnit       String? // lbs or kg
  spayedNeutered   Boolean @default(false)
  coverPhoto       String? // Hero banner image URL
  primaryPhotoUrl  String? // Main profile photo URL
  primaryPhotoIndex Int?    // Index of primary photo in photos array

  // Identification
  microchipId                  String?
  microchipCompany             String?
  microchipRegistrationStatus  String? // registered, not_registered, unknown
  microchipCertificateUrl      String?
  collarTagId                  String?
  insurancePolicyNumber        String?

  // Medical information
  vetClinicName    String?
  vetClinicContact String?
  allergies        String[] // Array of allergy names
  allergySeverities Json?   // Map of allergy name to severity (mild, moderate, severe)
  medications      Json?    // Array of medication objects
  conditions       Json?    // Array of condition objects with name, diagnosedAt, notes

  // Personality and preferences
  personality      Json? // Array of trait strings
  favoriteThings   Json? // { treats: string, toys: string, activities: string[] }
  specialNeeds     String?
  dislikes         String?

  // Profile content
  bio              String?
  isFeatured       Boolean @default(false) // Featured pet on owner's profile

  // Privacy settings
  privacy          Json? // { visibility: string, sections: object, interactions: object }

  // Social features
  followers        String[] // User IDs following this pet
  followRequests   String[] // Pending follow requests

  // Photo management
  photoCaptions    Json? // Map of photo URL to caption
  photoTags        Json? // Map of photo URL to array of pet IDs tagged

  // Weight history
  weightHistory    Json? // Array of { date: string, weight: number, unit: string, notes?: string }

  // Metadata
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?

  // Relations
  photos         PetPhoto[]
  timelineEvents PetTimelineEvent[]

  @@unique([ownerId, slug])
  @@index([ownerId])
  @@index([slug])
  @@index([species])
  @@index([deletedAt])
  @@map("pets")
}

// Pet Photo model - manages pet photo gallery
model PetPhoto {
  id           String  @id @default(uuid())
  petId        String
  url          String
  thumbnailUrl String?
  optimizedUrl String? // WebP optimized version
  caption      String?
  taggedPetIds String[] // Pet IDs tagged in this photo
  isPrimary    Boolean  @default(false)
  order        Int      @default(0) // Display order in gallery

  uploadedAt   DateTime @default(now())

  // Relations
  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([petId, isPrimary])
  @@index([petId, order])
  @@map("pet_photos")
}

// Pet Timeline Event model - tracks milestones and activities
model PetTimelineEvent {
  id           String   @id @default(uuid())
  petId        String
  type         String // added_to_family, vet_visit, vaccination, birthday, achievement, health_update, new_friend, custom
  title        String
  description  String
  date         DateTime
  photos       String[] // Array of photo URLs
  relatedPetId String? // For "new_friend" events linking to another pet

  // Engagement
  reactions    Json? // Map of reaction type to array of user IDs
  comments     Json? // Array of comment objects

  // Privacy
  visibility   String   @default("public") // public, followers_only, private

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  pet Pet @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([petId])
  @@index([petId, date(sort: Desc)])
  @@index([type])
  @@map("pet_timeline_events")
}

// ============================================================================
// MODERATION SYSTEM - EDIT REQUESTS & REVIEW WORKFLOW
// ============================================================================

// Edit Request model - tracks proposed changes to content awaiting moderation
model EditRequest {
  id          String   @id @default(uuid())
  contentType String // 'blog' | 'wiki' | 'pet' | 'profile'
  contentId   String
  userId      String
  status      String   @default("pending") // 'pending' | 'approved' | 'rejected'
  priority    String   @default("normal") // 'low' | 'normal' | 'high' | 'urgent'
  changes     Json // Structured diff showing additions/deletions
  reason      String? // Optional reason for the edit
  reviewedBy  String? // Moderator who reviewed
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Metadata for queue classification
  isCOI              Boolean  @default(false) // Conflict of Interest flag
  isFlaggedHealth    Boolean  @default(false) // Health-related content flag
  isNewPage          Boolean  @default(false) // New content creation flag
  hasImages          Boolean  @default(false) // Contains image uploads flag
  categories         String[] // Hidden categories for internal triage

  // Relations
  user     User  @relation("EditRequests", fields: [userId], references: [id], onDelete: Cascade)
  reviewer User? @relation("ReviewedEdits", fields: [reviewedBy], references: [id])

  @@index([status, createdAt(sort: Desc)])
  @@index([contentType, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([isCOI, status])
  @@index([isFlaggedHealth, status])
  @@index([isNewPage, status])
  @@index([reviewedBy])
  @@map("edit_requests")
}

// Link Whitelist model - pre-approved domains for content links
model LinkWhitelist {
  id        String   @id @default(uuid())
  domain    String   @unique
  reason    String? // Reason for whitelisting
  addedBy   String
  addedAt   DateTime @default(now())

  // Relations
  moderator User @relation("WhitelistedLinks", fields: [addedBy], references: [id])

  @@index([domain])
  @@map("link_whitelist")
}

// Link Blacklist model - blocked domains for content links
model LinkBlacklist {
  id        String   @id @default(uuid())
  domain    String   @unique
  reason    String? // Reason for blacklisting
  addedBy   String
  addedAt   DateTime @default(now())

  // Relations
  moderator User @relation("BlacklistedLinks", fields: [addedBy], references: [id])

  @@index([domain])
  @@map("link_blacklist")
}

// Moderation Category model - internal triage categories for edit requests
model ModerationCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdBy   String
  createdAt   DateTime @default(now())

  // Relations
  moderator User @relation("ModerationCategories", fields: [createdBy], references: [id])

  @@index([name])
  @@map("moderation_categories")
}
